---
layout: post
title: "Linux Project Development"
date: 2014-04-08 1:00
category: Linux
tags: [Linux]
---

Introduction
============

Many projects use a development process similar to what has been
developed by Linus Torvalds and others for the Linux kernel.
Projects such as: Linux[[1]], Git[[2]] and Subsurface[[3]].

These projects share some common characteristics.  All patches are sent
to a public mailing list and undergo a review process before being
accepted.  There is usually one person in control of the official
repository who decides which patches to accept.  The community is
typically very positive.  However they do not like wasting time.
Patches must be correctly prepared to ensure they are as easy to accept
as possible.  And Git is the primary tool for managing patches and
projects.

This is a collection of "tips and tricks" I have collected while working
on these projects.


Typical Work Flow
=================

    (make some changes)
    git commit -F log.txt --signoff
    git format-patch --cover-letter --reroll-count=2 -1
    (edit the cover letter)
    git send-email --to foo@bar.com --cc foo2@bar.com v2-0*

Log Messages
============

The width of a log message should be limited so that it fits on a 80
character terminal without wrapping.  A good rule of thumb is to use 72
characters.  This works for git log messages, which add 4 spaces.  And
it also works on mailing lists, where patch comments can be several
levels deep.

Formatting Patches
==================

Before commits can be sent by email they need to be formatted.  The `git
format-patch` command is used to do this.  It will produce a patch in
mbox format which can be sent with `git send-email`.

    git format-patch -1     # last change
    git format-patch -2     # last 2 changes

    git format-patch --cover-letter -1      # add a cover letter

    git format-patch --reroll-count=2 -1    # version 2

    git format-patch --signoff -1           # add a Signed-off-by
    * Note: --signoff can also be added during a commit

    git format-patch --signoff -1           # add a Signed-off-by

Patch Size
==========

A patch should be as small as possible so it can be easily reviewed.
But it must not be so small that it is incomplete.  The application
of every patch in a series must keep the project in a working state.
Imagine trying to bisect a patch series where each patch left the
project in a broken state.  It would be a pain to say the least.

Cover Letter
============

It is helpful to add a cover letter than gives an introduction to the
patch series.  It should also describe what has been done in previous
versions and possibly links to previous conversations.  Also, ordering
the changes in descending order helps to show what has most recently
changed.

    Changes in v3:
      - Removed #ifdef in header file.
    
    Changes in v2:
      - Changed strnncmp to use strncmp instead of memcmp.

Reply To Revisions
==================

Often a patch will be submitted.  Then others will comment on it.
And then revised patches will be submitted.  It is important to keep
this discussion as linear and coherent as possible.  Imagine if they
joined the conversation at revision 8, could they easily lookup the
previous discussion?

One way to do this is to have each to patch revision start a new subject
but provide links to the previous discussions on a mailing list.

    Version 3 of the patch series to cleanup duplicate name_compare()
    functions (previously was 'add strnncmp() function' [1]).  
    
    [1]: http://marc.info/?l=git&m=140299051431479&w=2

Another more advanced way is to make the new patch revision a reply to the
previous by using the "Message-id".  The first step is to find the
message id in the email headers.

    ...
    Subject: [PATCH 1/2] fixed commit
    Date: Sun, 22 Jun 2014 08:01:44 -0700
    Message-Id: <1403449304-551-1-git-send-email-jmmahler@gmail.com>
    X-Mailer: git-send-email 2.0.0
    ...

Next, the `--in-reply-to` option is used with `send-email`.  Be sure to
quote the id or else the shell might mis-interpret the meaning.

    git send-email \
      --in-reply-to="<1403449304-551-1-git-send-email-jmmahler@gmail.com>" \
      --to=jmm 0002-added-.gitignore.patch

Now the discussion of an entire patch series can be done in one thread
with no breaks.

Mutt Email Aliases
==================

Having to type a full email address in to `git send-email` can get
tedious.  Luckily aliases can be setup to make this easier [[8]].  The
configuration is done in Mutt but `send-email` uses the same
configuration.

First, configuration variables are added to Git.

    git config --global sendemail.aliasfiletype mutt
    git config --global sendemail.aliasesfile $HOME/.muttrc

Then the aliases should be added to the `~/.muttrc`.

    alias jmm Jeremiah Mahler <jmmahler@gmail.com>
    alias git git@vger.kernel.org

Now send-email can be used with an alias.

    git send-email --to jmm --cc git  00*.patch

Tags
====

    Signed-off-by:
    Reviewed-by:
    Tested-by:
    Suggested-by:
    Reported-by:
    Acked-by:
    Cc:
    Link: http://www.kernel.org

Retrieving Patches
==================

Often when going through the log history it is necessary to look at a
single patch.  There are many way to specify revisions (`gitrevisions(5)`) but
a short way to request the first patch (-1) from a given sha1.

    git format-patch -1 6630f11b

References
==========

  [1] [Linux][1]
  [1]: http://www.kernel.org

  [2] [Git][2]
  [2]: https://git.kernel.org/cgit/git/git.git/

  [3] [Subsurface][3]
  [3]: http://git.hohndel.org/?p=subsurface.git

  [4] [Junio on code churn patches][4]
  [4]: http://thread.gmane.org/gmane.comp.version-control.git/245133/focus=245144
  [5] [Theodore Tso on code churn (wankery)][5]
  [5]: https://lkml.org/lkml/2014/6/10/819

  [6] [Peff: using git rebase to test a patch series][6]
  [6]: http://marc.info/?l=git&m=140316809529679&w=2

  [7] [Documentation/CodingStyle][7]
  [7]: https://www.kernel.org/doc/Documentation/CodingStyle

  [8] [Felipe Contreras: git-send-email-tricks][8]
  [8]: http://felipec.wordpress.com/2009/10/25/git-send-email-tricks/

  [9] [Kroah on Top Posting][9]
  [9]: https://lkml.org/lkml/2005/1/11/111

  [10] [Linus on Trivial Patches][10]
  [10]: https://lkml.org/lkml/2004/12/20/255

