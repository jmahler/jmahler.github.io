---
layout: post
title: "Linux Kernel Notes"
date: 2014-04-08 1:00
category: Linux
tags: [Linux]
---

Notes about building a custom Linux kernel,
building modules, and submitting patches.

Getting The Kernel Sources
--------------------------

`git clone` either the stable or unstable.

stable (Kroah) development:

    git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git

unstable (Linus) development:

    git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

Configuring the Kernel
----------------------

Configuration is necessary before the kernel or any modules can be built.

Building the kernel requires a lot of disc space.
The source itself is 2 GB. During compilation it can easily exceed
15 GB.  At minimum of 20 GB of free disc space is recommended.

To use an existing config, such as from a distro, it can be
copied to the root of the Linux source tree as `.config`.
Then make oldconfig can be run to configure any new options.

    cp /boot/config-`uname -r` .config
    make oldconfig

Once configuration is complete it should be prepared.

    make prepare

Now it should be possible to build the kernel or modules.

Building the Kernel and/or Modules
----------------------------------

To build everything simply type make.  Here the `-j` option is used to
take advantage of multiple processors.  2 in this case.

    make -j2

It is also possible to build just a portion of the project by
using the M= option.  This is useful when building drivers.

    make M=scripts
    make M=drivers/staging/comedi/drivers

Installing the Kernel
---------------------

On a Debian system, if the kernel is built using make-kpkg
(from `kernel-package`), it will produce a .deb that can be used
to install the kernel.  This is the preferred method because it
will take care of placing files and configuring Grub correctly.

    make-kpkg -j2 --rootcmd fakeroot --initrd kernel_image
    sudo dpkg -i kernel.deb

The deb will be located in the parent directory.

    sudo dpkg -i ../linux-image-3.15.0-rc5_3.15.0-rc5-10.00.Custom_amd64.deb

Generating a Patch
------------------

Make your own branch for your own changes.

    git branch newfeature
    git checkout mnewfeature

After changes have been made it should be built.

    make M=drivers/staging/comedi/drivers

It should be checked for any style warnings and all
problems should be fixed [[6],[7]].

    ./scripts/checkpatch.pl --file drivers/staging/comedi/drivers/ssv_dnp.c

When the changes are complete, make a commit.
A `Signed-off-by:` entry must be added to indicate that you are the
creator of this patch and that it complies with the licensing terms
of the project.  The --signoff can be added during a commit.

    git commit --signoff

If a --signoff is not added in the log message it can be added later
with `format-patch`.

The `format-patch` command is used to format a patch suitable for
sending to a mailing list.

    git format-patch origin

If a --signoff was not added in the commit it can also be added
when using format-patch.

    git format-patch --signoff origin

This will result in a new patch.

    0001-my-first-patch.patch

Check the patch for any style or formatting problems.

    ./scripts/checkpatch.pl 0001-my-first-patch.patch

Typical Workflow
----------------

    (make some changes)
    git commit -F log.txt --signoff
    git format-patch --cover-letter --reroll-count=2 -1
    (edit the cover letter)
    git send-email --to foo@bar.com --cc foo2@bar.com v2-0*

Formatting Patches
------------------

Before commits can be sent in an email they need to be formatted.
The `git format-patch` command is used to do this.
It will produce a patch in mbox format for use with `git send-email`
which will be discussed later.

    git format-patch -1     # last change
    git format-patch -2     # last 2 changes

    git format-patch --cover-letter -1      # add a cover letter

    git format-patch --reroll-count=2 -1    # version 2

    git format-patch --signoff -1           # add a Signed-off-by
    * Note: --signoff can also be added during a commit

    git format-patch --signoff -1           # add a Signed-off-by

Emailing Patches
----------------

Before emailing a patch it is necessary to determine who to send
that patch to.  The mailing list for the project is always good.
But it is also good to send it to people who have worked on the code.

In the kernel sources the `get_maintainer.pl` script can be used to
find the relevant people.

    ./scripts/get_maintainer.pl 0001-my-first-patch.patch

Alternatively, it can be used directly on a file.

    ./scripts/get_maintainer.pl --file drivers/staging/comedi/drivers/ssv_dnp.c

Another good place to look is in the MAINTAINERS file included with the
kernel sources.

    (see MAINTAINERS file)
    trivial@kernel.org                trivial patches
    linux-kernel@vger.kernel.org      Linux kernel mailing list

    git@vger.kernel.org               Git mailing list

The preferred way to send a patch is using `git send-email`.
It will also parse the patch and recommended additional email addresses
to send the patch to.  Often those with `Signed-off by` or other tags.

    git send-email --to jmmahler@gmail.com --cc linux-kernel@vger.kernel.org \
        0001-my-first-patch.patch

If there are multiple parts, perhaps a cover letter and multiple patches,
a glob pattern can be used.

    git send-email --to jmmahler@gmail.com --cc linux-kernel@vger.kernel.org \
        00*.patch

It can get a bit tedious having to type these email addresses every time.
Luckily, `git send-email` has an alias feature [[8]].
For `mutt` the following config commands could be used.

    git config sendemail.aliasfiletype mutt
    git config sendemail.aliasesfile $HOME/.muttrc

And the `.muttrc` file should contain alias commands like below.

    alias jmm Jeremiah Mahler <jmmahler@gmail.com>
    alias git git@vger.kernel.org

*NOTE* - If it doesn't work, check the config names.
`sendemail.aliasesfile` is not the same as ` sendemail.aliasfile`.

Now send-email can be used with an alias.

    git send-email --to jmm --cc git  00*.patch

Applying a Mailed Patch
-----------------------

A patch received in an email can be applied by using the `git am` command.
It accepts the message in mbox format which contains not only the diff
but also the log message to be used for git.

    git am patch.mbox

Following Upstream
------------------

When a project is cloned it is automatically setup to track the origin.
So a `git pull` will automatically pull updates from that origin.
Local changes are kept local an updates can be pulled from upstream.

But suppose you have a mirror of the upstream project on your own server.
If you clone from your project then it will not be setup to pull updates
from the origin.

To git around this situation the `git remote` can be used along with
`git pull -u`.  Consider the following example.

First you clone from your server.

    git clone git@github.com:jmahler/git

Then add the upstream remote.  To view your remotes try `remote -v`.

    git remote add upstream git://git.kernel.org/pub/scm/git/git

Finally, you need to configure your local branch to track upstream
and not origin (your server).  Here the `pu` branch is used.

    git branch -u upstream/pu pu

There are several ways to use `branch -u`, this is one of the more explicit
variations.

Need Something TODO?
--------------------

    find ./ -name TODO

References
==========

  [1] [http://kernelnewbies.org][1]
  [1]: http://kernelnewbies.org

  [2] [http://kernelnewbies.org/KernelBuild][2]
  [2]: http://kernelnewbies.org/KernelBuild

  [3] [http://git.kernel.org][3]
  [3]: http://git.kernel.org

  [4] [http://www.debian.org/doc/manuals/debian-faq/ch-kernel.en.html][4]
  [4]: http://www.debian.org/doc/manuals/debian-faq/ch-kernel.en.html

  [5] [Linux Kernel in a Nutshell][5]
  [5]: http://www.kroah.com/lkn/

  [6] [YouTube: Write and Submit your first Linux kernel Patch][6]
  [6]: https://www.youtube.com/watch?v=LLBrBBImJt4

  [7] [Documentation/CodingStyle][7]
  [7]: https://www.kernel.org/doc/Documentation/CodingStyle

  [8] [Felipe Contreras: git-send-email-tricks][8]
  [8]: http://felipec.wordpress.com/2009/10/25/git-send-email-tricks/

  [9] [Kroah on Top Posting][9]
  [9]: https://lkml.org/lkml/2005/1/11/111

  [10] [Linus on Trivial Patches][10]
  [10]: https://lkml.org/lkml/2004/12/20/255

