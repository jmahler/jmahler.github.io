---
layout: post
title: "Linux Kernel Notes"
date: 2014-04-08 1:00
category: Linux
tags: [Linux]
---

Notes about building a custom Linux kernel,
building modules, and submitting patches.

Getting The Kernel Sources
--------------------------

stable (Kroah) development:

    git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git

new (Linus) development:

    git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

To list all the tags.

    git tag -l | less

Configuring the Kernel
----------------------

Configuration is necessary before the kernel or any modules can be built.

Building the kernel requires a lot of disc space.
The source itself is 2 GB. During compilation it can easily exceed
15 GB.  At minimum of 20 GB of free disc space is recommended.

To use an existing config, such as from a distro, it can be
copied to the root of the Linux source tree as `.config`.
Then make oldconfig can be run to configure any new options.

    cp /boot/config-`uname -r` .config
    make oldconfig

`make oldconfig` will prompt for each new option.
However they may be a large number which would be time consuming
to process.  To just say yes to everything use the `yes` program.

    yes "" | make oldconfig

Alternatively, to create a new configuration, menuconfig or
nconfig can be used.

    make menuconfig

or

    make nconfig

Once configuration is complete it should be prepared.

    make prepare

Now it should be possible to build the kernel and/or modules.

Building the Kernel and/or Modules
----------------------------------

To build everything simply type make.

    make

To take advantage of multiple processors the `-j` option can be used.
The following uses 2 processors.

    make -j2

It is also possible to build just a portion of the project by
using the M= option.  This is useful when building drivers.

    make M=scripts
    make M=drivers/staging/comedi/drivers

Installing the Kernel
---------------------

On a Debian system, if the kernel is built using make-kpkg
(from `kernel-package`), it will produce a .deb that can be used
to install the kernel.  This is the preferred method because it
will take care of placing files and configuring Grub correctly.

    make-kpg -j2 --rootcmd fakeroot --initrd kernel_image
    sudo dpkg -i kernel.deb

The deb will be located in the parent directory.

    sudo dpkg -i ../linux-image-3.15.0-rc5_3.15.0-rc5-10.00.Custom_amd64.deb

Generating a Patch
------------------

Make your own branch for your own changes.

    git branch newfeature
    git checkout mnewfeature

After changes have been made it should be built.

    make M=drivers/staging/comedi/drivers

It should be checked for any style warnings and all
problems should be fixed [[6],[7]].

    ./scripts/checkpatch.pl --file drivers/staging/comedi/drivers/ssv_dnp.c

When the changes are complete, make a commit.
A `Signed-off-by:` entry must be added to indicate that you are the
creator of this patch and that it complies with the licensing terms
of the project.  The --signoff can be added during a commit.

    git commit --signoff

If a --signoff is not added in the log message it can be added later
with `format-patch`.

The `format-patch` command is used to format a patch suitable for
sending to a mailing list.

    git format-patch origin

If a --signoff was not added in the commit it can also be added
when using format-patch.

    git format-patch --signoff origin

This will result in a new patch.

    0001-my-first-patch.patch

Check the patch for any style or formatting problems.

    ./scripts/checkpatch.pl 0001-my-first-patch.patch

Next, it is necessary to determine who to send the patch to.
The get_maintainer.pl script can be used to find all the relevant
people.

    ./scripts/get_maintainer.pl 0001-my-first-patch.patch

This script can also be used directly on a file.

    ./scripts/get_maintainer.pl --file drivers/staging/comedi/drivers/ssv_dnp.c

Finally, the patch can be sent.

    git send-email --to jmmahler@gmail.com --cc linux-kernel@vger.kernel.org \
        0001-my-first-patch.patch

If there are multiple patches, additional steps may be necessary to
properly describe the order [[6]].

Replying To Patches
-------------------

The first submitted patch is not always accepted.
Revisions will have to made response to suggestions from others.
But this process must be kept as simple and efficient as possible.

To indicate which patch revision this is the --reroll-count option can
be used.  Instead of just a plain [PATCH] in the subject it will add
a version number such as [PATCH v2].

    git format-patch --reroll-count=2 -1

This process will result in breaks between revisions of the email thread.
But this does not appear to be an issue because no complaints have been seen.

It is often desirable to add a message which describes what issues were
addressed in the patch revision.  But this message should not be included
in the commit history.  To accomplish this the --cover-letter option can
be used.  It will create a top most parent email in the thread with all
the patches as children.

    git format-patch --cover-letter --reroll-count=2 -1

When this process is finally complete and a maintainer decides
that the patch is ready for inclusion he will add a
`Reviewed-by` tag.

Need Something TODO?
--------------------

    find ./ -name TODO

References
==========

  [1] [http://kernelnewbies.org][1]
  [1]: http://kernelnewbies.org

  [2] [http://kernelnewbies.org/KernelBuild][2]
  [2]: http://kernelnewbies.org/KernelBuild

  [3] [http://git.kernel.org][3]
  [3]: http://git.kernel.org

  [4] [http://www.debian.org/doc/manuals/debian-faq/ch-kernel.en.html][4]
  [4]: http://www.debian.org/doc/manuals/debian-faq/ch-kernel.en.html

  [5] [Linux Kernel in a Nutshell][5]
  [5]: http://www.kroah.com/lkn/

  [6] [YouTube: Write and Submit your first Linux kernel Patch][6]
  [6]: https://www.youtube.com/watch?v=LLBrBBImJt4

  [7] [Documentation/CodingStyle][7]
  [7]: https://www.kernel.org/doc/Documentation/CodingStyle

