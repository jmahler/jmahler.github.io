---
layout: post
title: "Linux Kernel Notes"
date: 2014-04-08 1:00
category: Linux
tags: [Linux]
---

Notes about building a custom Linux kernel,
building modules, and submitting patches.

Getting The Kernel Sources
--------------------------

`git clone` either the stable or unstable.

stable (Kroah) development:

    git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git

unstable (Linus) development:

    git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

Configuring a Kernel
--------------------

Configuration is necessary before the kernel or any modules can be built.

Building the kernel requires a lot of disc space.
The source itself is 2 GB. During compilation it can easily exceed
15 GB.  At minimum of 20 GB of free disc space is recommended.

To use an existing config, such as from a distro, it can be
copied to the root of the Linux source tree as `.config`.
Then make oldconfig can be run to configure any new options.

    cp /boot/config-`uname -r` .config
    make oldconfig

Building and Installing a Kernel
--------------------------------

Two different ways to build and install a kernel will be discussed here.
The first is the manual method which only use the scripts that come with
the Linux kernel.  The second will build an entire .deb package.

To build using the manual method simply type `make`.  The `-j` option
can be used to take advantage of multiple processors.

    make -j2

Once this is complete they are installed.

    make modules_install install

To build a .deb the `make-kpkg` command is used.

    make-kpkg -j2 --rootcmd fakeroot --initrd kernel_image

The resulting .deb will be in the parent directory and can be installed
using `dpkg`.

    sudo dpkg -i ../linux-image-3.15.0-rc5_3.15.0-rc5-10.00.Custom_amd64.deb

These two different methods each have their benefits.  The manual method
does less work during a rebuild.  `make-kpkg` seems to do everything
from a full clean every time.  The manual method will install the files
but they have to be manually removed.  Usually it is easy to find what
to remove in `/boot` and `/lib/modules` but it is not as clean as a .deb
which is easy to install and remove without leaving any files behind.
Also, if the files are manually removed, `update-grub` must be run as
well.

The manual method is better suited for developers where rebuild time is
important.  For distributing a kernel the .deb method is better because
of the clean install/remove process.

Huge Initrd Image, /boot full
-----------------------------

When doing the make install modules_install steps as described, a rather
large initrd image is produced.  On one system the initird image
produced was 151M.  Compare this to the image provided with Debian which
was 14M.  With a /boot partition of a few hundred megs it doesn't take
long to run out of space.

One option for producing a smaller image is to use `INSTALL_MOD_STRIP`.

    make INSTALL_MOD_STRIP=1 -j2 install

However in some cases this produces an image which wont boot.
It can fill without being able to mount the root file system.

    ...
    Loading, please wait...
    Gave up waiting for root device.  Common problems:
     - Boot args (cat /proc/cmdline)
    ...
     - Missing modules (cat /proc/modules; ls /dev)
    ...

Building Modules
----------------

The modules can be built independently from the kernel by using the `M=`
option.

    make M=scripts
    make M=drivers/staging/comedi/drivers

To add extra flags use the `EXTRA_CFLAGS` variable.

    make EXTRA_CFLAGS="-DDEBUG" M=drivers/staging/comedi/drivers

Generating a Patch
------------------

Make your own branch for your own changes.

    git branch newfeature
    git checkout mnewfeature

After changes have been made it should be built.

    make M=drivers/staging/comedi/drivers

It should be checked for any style warnings and all
problems should be fixed [[6],[7]].

    ./scripts/checkpatch.pl --file drivers/staging/comedi/drivers/ssv_dnp.c

When the changes are complete, make a commit.
A `Signed-off-by:` entry must be added to indicate that you are the
creator of this patch and that it complies with the licensing terms
of the project.  The --signoff can be added during a commit.

    git commit --signoff

If a --signoff is not added in the log message it can be added later
with `format-patch`.

The `format-patch` command is used to format a patch suitable for
sending to a mailing list.

    git format-patch origin

If a --signoff was not added in the commit it can also be added
when using format-patch.

    git format-patch --signoff origin

This will result in a new patch.

    0001-my-first-patch.patch

Check the patch for any style or formatting problems.

    ./scripts/checkpatch.pl 0001-my-first-patch.patch

Emailing Patches
----------------

Before emailing a patch it is necessary to determine who to send
that patch to.  The mailing list for the project is always good.
But it is also good to send it to people who have worked on the code.

In the kernel sources the `get_maintainer.pl` script can be used to
find the relevant people.

    ./scripts/get_maintainer.pl 0001-my-first-patch.patch

Alternatively, it can be used directly on a file.

    ./scripts/get_maintainer.pl --file drivers/staging/comedi/drivers/ssv_dnp.c

Another good place to look is in the MAINTAINERS file included with the
kernel sources.

    (see MAINTAINERS file)
    trivial@kernel.org                trivial patches
    linux-kernel@vger.kernel.org      Linux kernel mailing list

    git@vger.kernel.org               Git mailing list

The preferred way to send a patch is using `git send-email`.
It will also parse the patch and recommended additional email addresses
to send the patch to.  Often those with `Signed-off by` or other tags.

    git send-email --to jmmahler@gmail.com --cc linux-kernel@vger.kernel.org \
        0001-my-first-patch.patch

If there are multiple parts, perhaps a cover letter and multiple patches,
a glob pattern can be used.

    git send-email --to jmmahler@gmail.com --cc linux-kernel@vger.kernel.org \
        00*.patch

It can get a bit tedious having to type these email addresses every time.
Luckily, `git send-email` has an alias feature [[8]].
For `mutt` the following config commands could be used.

    git config sendemail.aliasfiletype mutt
    git config sendemail.aliasesfile $HOME/.muttrc

And the `.muttrc` file should contain alias commands like below.

    alias jmm Jeremiah Mahler <jmmahler@gmail.com>
    alias git git@vger.kernel.org

*NOTE* - If it doesn't work, check the config names.
`sendemail.aliasesfile` is not the same as ` sendemail.aliasfile`.

Now send-email can be used with an alias.

    git send-email --to jmm --cc git  00*.patch

Applying a Mailed Patch
-----------------------

A patch received in an email can be applied by using the `git am` command.
It accepts the message in mbox format which contains not only the diff
but also the log message to be used for git.

    git am patch.mbox

Following Upstream
------------------

When a project is cloned it is automatically setup to track the origin.
So a `git pull` will automatically pull updates from that origin.
Local changes are kept local an updates can be pulled from upstream.

But suppose you have a mirror of the upstream project on your own server.
If you clone from your project then it will not be setup to pull updates
from the origin.

To git around this situation the `git remote` can be used along with
`git pull -u`.  Consider the following example.

First you clone from your server.

    git clone git@github.com:jmahler/git

Then add the upstream remote.  To view your remotes try `remote -v`.

    git remote add upstream git://git.kernel.org/pub/scm/git/git

Finally, you need to configure your local branch to track upstream
and not origin (your server).  Here the `pu` branch is used.

    git branch -u upstream/pu pu

There are several ways to use `branch -u`, this is one of the more explicit
variations.

Need Something TODO?
--------------------

    find ./ -name TODO

References
==========

  [1] [http://kernelnewbies.org][1]
  [1]: http://kernelnewbies.org

  [2] [http://kernelnewbies.org/KernelBuild][2]
  [2]: http://kernelnewbies.org/KernelBuild

  [3] [http://git.kernel.org][3]
  [3]: http://git.kernel.org

  [4] [http://www.debian.org/doc/manuals/debian-faq/ch-kernel.en.html][4]
  [4]: http://www.debian.org/doc/manuals/debian-faq/ch-kernel.en.html

  [5] [Linux Kernel in a Nutshell][5]
  [5]: http://www.kroah.com/lkn/

  [6] [YouTube: Write and Submit your first Linux kernel Patch][6]
  [6]: https://www.youtube.com/watch?v=LLBrBBImJt4

  [7] [Documentation/CodingStyle][7]
  [7]: https://www.kernel.org/doc/Documentation/CodingStyle

  [8] [Felipe Contreras: git-send-email-tricks][8]
  [8]: http://felipec.wordpress.com/2009/10/25/git-send-email-tricks/

